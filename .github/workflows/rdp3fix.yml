name: Ubuntu Desktop with noVNC and Tunnel (Corrected)

on:
  workflow_dispatch:

jobs:
  run-desktop:
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver git curl wget openssh-client

    - name: Setup VNC server with password from Secret
      env:
        VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
      run: |
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯Ù‡Ø§ ÙÙŠ Ø§Ù„Ù€ Secrets
        if [ -z "$VNC_PASSWORD" ]; then
          echo "Error: VNC_PASSWORD secret is not set in GitHub repository settings."
          exit 1
        fi
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ VNC
        mkdir -p ~/.vnc
        echo "$VNC_PASSWORD" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

        echo '#!/bin/bash
        xrdb $HOME/.Xresources
        startxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup

    - name: Start VNC and noVNC services
      run: |
        # Ø¨Ø¯Ø¡ Ø®Ø§Ø¯Ù… VNC ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        vncserver :1 -geometry 1280x720 -depth 24
        
        # Ø§Ø³ØªÙ†Ø³Ø§Ø® noVNC
        git clone https://github.com/novnc/noVNC.git ~/noVNC
        
        # ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… noVNC ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        ~/noVNC/utils/launch.sh --vnc localhost:5901 --listen 6080 &

    - name: Create tunnel with serveo.net and get URL
      id: tunnel # Ù†Ø¹Ø·ÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ù…Ø¹Ø±ÙØ§Ù‹ (ID) Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ø®Ø±Ø¬Ø§ØªÙ‡Ø§
      run: |
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ÙÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª ÙÙŠ Ù…Ù„Ù log
        ssh -o StrictHostKeyChecking=no -R 80:localhost:6080 serveo.net > tunnel.log 2>&1 &
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù† Ø­ØªÙ‰ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†ÙÙ‚
        sleep 8
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù… Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù€ log
        # Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ serveo.net Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ù‚Ø¯ ØªÙØ´Ù„
        PUBLIC_URL=$(grep -o 'https://[a-zA-Z0-9-]*\.serveo\.net' tunnel.log)
        
        if [ -z "$PUBLIC_URL" ]; then
          echo "::error:: Failed to get public URL from serveo.net. The service might be down."
          echo "Log content:"
          cat tunnel.log
          exit 1
        fi
        
        # ØªØµØ¯ÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· ÙƒÙ…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ù„Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©
        echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV
        echo "Tunnel is up at: $PUBLIC_URL"

    - name: Show connection info and keep alive
      run: |
        echo "------------------------------------------------------"
        echo "âœ… Ubuntu Desktop is running!"
        echo "ğŸŒ Public URL: ${{ env.PUBLIC_URL }}"
        echo "ğŸ”‘ VNC Password is the one you set in the VNC_PASSWORD secret."
        echo "------------------------------------------------------"
        echo "âš ï¸ WARNING: serveo.net can be unstable. If the URL doesn't work, the service may be down."
        echo "â„¹ï¸ This session will remain active for up to 6 hours."
        
        # Ø£Ù…Ø± Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ØªØ¹Ù…Ù„ Ù„Ø£Ø·ÙˆÙ„ ÙØªØ±Ø© Ù…Ù…ÙƒÙ†Ø©
        sleep 21000
